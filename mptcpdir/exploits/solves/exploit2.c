#define _GNU_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/socket.h>
#include <netinet/tcp.h>
#include <netinet/in.h>

#define MPTCP_ENABLED           42
#define MPTCP_SCHEDULER         43
#define MPTCP_PATH_MANAGER      44
#define MPTCP_INFO              45

struct ip_options {
	unsigned int    faddr;
	unsigned int    nexthop;
	unsigned char   optlen;
	unsigned char   srr;
	unsigned char   rr;
	unsigned char   ts;
	unsigned char   is_strictroute:1,
	srr_is_hit:1,
	is_changed:1,
	rr_needaddr:1,
	ts_needtime:1,
	ts_needaddr:1;
	unsigned char   router_alert;
	unsigned char   cipso;
	unsigned char   __pad2;
	unsigned char   __data[0];
};


int main(void){
	int fd_c,fd_s;
        struct sockaddr_in saddr, caddr, daddr;
	struct ip_options opt;
	int enabled;

	memset(&saddr,'\0',sizeof(saddr));
	memset(&caddr,'\0',sizeof(caddr));
	memset(&daddr,'\0',sizeof(daddr));
	memset(&opt,'\0',sizeof(opt));

	fd_s = socket(AF_INET,SOCK_STREAM,0);
	if(fd_s < 0){
		return 0;
	}

	fd_c = socket(AF_INET,SOCK_STREAM,0);
	if(fd_c < 0){
		return 0;
	}

	enabled = 1;

	if(setsockopt(fd_s,SOL_TCP,MPTCP_ENABLED,&enabled,4) < 0){
		perror("setsockopt");
		exit(EXIT_FAILURE);
	}

	char pathmanager[] = "ndiffports";
	if(setsockopt(fd_s, SOL_TCP, MPTCP_PATH_MANAGER, pathmanager, sizeof(pathmanager)) < 0){
		perror("pathmanager setsockopt");
		exit(EXIT_FAILURE);
	}

	char scheduler[] = "redundant";
	if(setsockopt(fd_s, SOL_TCP, MPTCP_SCHEDULER, scheduler, sizeof(scheduler)) < 0){
		perror("scheduler setsockopt");
		exit(EXIT_FAILURE);
	}

	saddr.sin_family = AF_INET;	
      	saddr.sin_port = htons(9090);

	if(bind(fd_s,(struct sockaddr *)&saddr,sizeof(saddr)) < 0){
		perror("bind");
		exit(EXIT_FAILURE);
	}

	if(listen(fd_s,10) < 0){
		perror("listen");
		exit(EXIT_FAILURE);
	}

	if(setsockopt(fd_c,SOL_TCP,MPTCP_ENABLED,&enabled,4) < 0){
		perror("setsockopt");
		exit(EXIT_FAILURE);
	}

	if(setsockopt(fd_c,SOL_IP,IP_OPTIONS,&opt,sizeof(opt)) < 0){
		perror("setsockopt ip_options");
		exit(EXIT_FAILURE);
	}

	caddr.sin_family = AF_INET;
	caddr.sin_port = htons(9090);
	caddr.sin_addr.s_addr = inet_addr("10.0.2.15"); 

	if(connect(fd_c,(struct sockaddr *)&caddr,sizeof(caddr)) < 0){
		perror("connect");
		exit(EXIT_FAILURE);
	}

	getchar();

	if(setsockopt(fd_c,SOL_IP,IP_OPTIONS,&opt,sizeof(opt)) < 0){
		perror("setsockopt ip_options");
		exit(EXIT_FAILURE);
	}

	getchar();

	close(fd_s);
	close(fd_c);

return 0;
}
